<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>STRIX</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css"
        integrity="sha512-MV7K8+y+gLIBoVD59lQIYicR65iaqukzvf/nwasF0nqhPay5w/9lJmVM2hMDcnK1OnMGCdVK+iQrJ7lzPJQd1w=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

    <meta property="og:title" content="STRIX">
    <meta property="og:description" content="String World">
    <meta property="og:image" content="https://lcw3176.github.io/background.jpg">
    <meta property="og:url" content="https://lcw3176.github.io/">
    
    <style>

        html {
            height: 100%;
            margin: 0px; padding: 0px;
        }


        body{
            margin: 0px; padding: 0px;
            background-image: url('background.jpg');
            height: 100%;
        }

        #app{
            min-height: 100%;
            border-radius: 30px;
            background-color: rgba(255,255,192,0.1);
            backdrop-filter: blur(1px);
            box-shadow: 2px 7px 15px 8px rgba(0,0,0,0.3);
        }

        #imageSrc {
            width: 800px;
            height: auto;
        }

        #canvasOutput {
            background-color: black;
        }
    </style>
</head>

<body>
    <div id="app" class="container is-fluid">
        <div class="columns">
            <div class="column is-half is-offset-one-quarter mt-5 has-text-centered">
                <!-- <h1 class="title">String World</h1> -->
            </div>
        </div>
    
        <div class="columns">
            <div class="column is-half is-offset-one-quarter mt-5 has-text-centered">
    
                <div class="inputoutput">
                    <div class="file is-boxed is-centered">
                        <label class="file-label">
                            <figure class="image">
                                <img id="imageSrcCopy" style="width: 400px; height: auto;" />
                            </figure>
    
                            <input type="file" id="fileInput" name="file" class="file-input" />
                            <span class="file-cta">
                                <span class="file-icon">
                                    <i class="fas fa-upload"></i>
                                </span>
                                <span class="file-label">
                                    이미지를 업로드하세요.
                                </span>
                            </span>
                        </label>
                    </div>
                </div>
            </div>
        </div>
    
        <div class="columns">
            <div class="column is-half is-offset-one-quarter mt-5 has-text-centered">
                <button class="button" onclick="start()" style="display: none;" id="startButton">이미지 만들기</button>
            </div>
        </div>
    
       
    
        <div class="columns">
            <div class="column is-half is-offset-one-quarter mt-5 has-text-centered">
                <progress class="progress is-success" id="progressBar" value="0" max="100"></progress>
                <a class="subtitle has-text-success" id="downloadLink"></button>
            </div>
        </div>
    
    
    
        <div class="inputoutput">
            <img id="imageSrc" style="display: none;" />
            <canvas id="canvasOutput" style="display: none;"></canvas>
        </div>
    
    </div>
   

    <script type="text/javascript">
        window.onload = function () {
            var myFont = new FontFace('myFont', 'url(NanumGothicCoding-Bold.ttf)');

            myFont.load().then(function (font) {
                document.fonts.add(font);
            })
        }

        let imgElement = document.getElementById('imageSrc');
        let inputElement = document.getElementById('fileInput');
        let copyImgElement = document.getElementById("imageSrcCopy");

        inputElement.addEventListener('change', (e) => {
            imgElement.src = URL.createObjectURL(e.target.files[0]);
            copyImgElement.src = imgElement.src;
            imgElement.onload = function () {
                document.getElementById("startButton").style.display = "inline";
            }
        }, false);

        async function start() {
            document.getElementById("startButton").className = "button is-loading";
            const textData = await makeText();

            await drawImage(textData);

        }

        function makeText() {
            return new Promise(function (resolve, reject) {
                let imgElement = document.getElementById('imageSrc');
                let chars = ' .,-~:;=!*#$@';
                let mat = cv.imread(imgElement);
                let dst = new cv.Mat();
                cv.cvtColor(mat, dst, cv.COLOR_RGBA2GRAY, 0);
                let w = dst.cols,
                    h = dst.rows;

                let arr = []
                let count = 0;

                function pushData() {
                    for (let i = 0; i < 3000; i++) {
                        arr.push(chars[parseInt(dst.data[count] / 256 * chars.length)]);
                        
                        document.getElementById("progressBar").value = parseInt(count / dst.data.length * 100);
                        count++;
                        
                        if (count % w == 0) {
                            arr.push("\n");
                        }
                    }

                    if (count < dst.data.length) {
                        setTimeout(pushData, 10);
                    } else {
                        let lines = arr.join().split("\n");
                        dst.delete();
                        mat.delete();

                        resolve(lines);
                    }

                }

                setTimeout(pushData, 10);

            });
        }

        function drawImage(textData) {
            return new Promise(function (resolve, reject) {
                var canvas = document.getElementById("canvasOutput");
                var ctx = canvas.getContext("2d");
                let imgElement = document.getElementById('imageSrc');

                ctx.clearRect(0, 0, canvas.width, canvas.height);

                canvas.width = imgElement.width * 5;
                canvas.height = imgElement.height * 5;
                ctx.font = "5px myFont";
                ctx.fillStyle = "white";
                for (let i = 0; i < textData.length; i++) {
                    ctx.fillText(textData[i], 0, 0 + i * 5);
                }

                canvas.toBlob(function (blob) {
                    var link = document.getElementById('downloadLink');
                    link.download = 'strix.jpg';
                    link.href = canvas.toDataURL('image/jpeg', 1.0)
                    link.innerText = "다운로드";

                    link.href = URL.createObjectURL(blob);
                    document.getElementById("startButton").className = "button";
                }, 'image/jpeg');
            })
        }


    </script>
    <script async src="opencv.js" type="text/javascript"></script>
</body>

</html>