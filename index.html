<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>String World</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css"
        integrity="sha512-MV7K8+y+gLIBoVD59lQIYicR65iaqukzvf/nwasF0nqhPay5w/9lJmVM2hMDcnK1OnMGCdVK+iQrJ7lzPJQd1w=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        #imageSrc {
            width: 1000px;
            height: auto;
        }

        #canvasOutput {
            background-color: black;
        }
    </style>
</head>

<body>
    <div class="columns">
        <div class="column is-half is-offset-one-quarter mt-5 has-text-centered">
            <h1 class="title">String World</h1>
        </div>
    </div>

    <div class="columns">
        <div class="column is-half is-offset-one-quarter mt-5 has-text-centered">

            <div class="inputoutput">
                <div class="file is-boxed is-centered">
                    <label class="file-label">
                        <figure class="image">
                            <img id="imageSrcCopy" style="width: 400px; height: auto;"/>
                        </figure>

                        <input type="file" id="fileInput" name="file" class="file-input" />
                        <span class="file-cta">
                            <span class="file-icon">
                                <i class="fas fa-upload"></i>
                            </span>
                            <span class="file-label">
                                Choose a file
                            </span>
                        </span>
                    </label>
                </div>
            </div>
        </div>
    </div>

    <div class="columns">
        <div class="column is-half is-offset-one-quarter mt-5 has-text-centered">
            <button class="button" style="display: none;" onclick="start()" id="startButton">이미지 만들기</button>
        </div>
    </div>

    <div class="columns">
        <div class="column is-half is-offset-one-quarter mt-5 has-text-centered">
            <a class="subtitle" id="downloadLink"></button>
        </div>
    </div>



    <div class="inputoutput">
        <img id="imageSrc" style="display: none;"/>
        <canvas id="canvasOutput" style="display: none;"></canvas>
    </div>

    </div>


    <script type="text/javascript">
        window.onload = function () {
            var myFont = new FontFace('myFont', 'url(NanumGothicCoding-Bold.ttf)');

            myFont.load().then(function (font) {
                document.fonts.add(font);
            })
        }

        let imgElement = document.getElementById('imageSrc');
        let inputElement = document.getElementById('fileInput');
        let copyImgElement = document.getElementById("imageSrcCopy");

        inputElement.addEventListener('change', (e) => {
            imgElement.src = URL.createObjectURL(e.target.files[0]);
            copyImgElement.src = imgElement.src;
            imgElement.onload = function () {
                document.getElementById("startButton").style.display = "inline";
            }
        }, false);

        async function start() {
            document.getElementById("startButton").className = "button is-loading";
            await makeImage();
            document.getElementById("startButton").className = "button";
        }

        function makeImage() {
            return new Promise(function () {
                let imgElement = document.getElementById('imageSrc');
                let chars = ' .,-~:;=!*#$@';
                let mat = cv.imread(imgElement);
                let dst = new cv.Mat();
                cv.cvtColor(mat, dst, cv.COLOR_RGBA2GRAY, 0);
                let w = dst.cols,
                    h = dst.rows;

                let arr = []

                for (let i = 0; i < dst.data.length; i++) {
                    arr.push(chars[parseInt(dst.data[i] / 256 * chars.length)]);

                    if (i % w == 0) {
                        arr.push("\n");
                    }
                }

                let lines = arr.join().split("\n");
                var canvas = document.getElementById("canvasOutput");
                var ctx = canvas.getContext("2d");
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                canvas.width = imgElement.width * 5;
                canvas.height = imgElement.height * 5;
                ctx.font = "5px myFont";
                ctx.fillStyle = "white";
                for (let i = 0; i < lines.length; i++) {
                    ctx.fillText(lines[i], 0, 0 + i * 5);
                }

                canvas.toBlob(function (blob) {
                    var link = document.getElementById('downloadLink');
                    link.download = 'hello.jpg';
                    link.href = canvas.toDataURL('image/jpeg', 1.0)
                    link.innerText = "다운로드";

                    link.href = URL.createObjectURL(blob);

                    dst.delete();
                    mat.delete();

                    document.getElementById("startButton").className = "button";
                }, 'image/jpeg');
            })

        }


    </script>
    <script async src="opencv.js" type="text/javascript"></script>
</body>

</html>