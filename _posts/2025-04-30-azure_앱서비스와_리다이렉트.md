---
date: 2025-04-30
layout: post
title: azure 앱서비스와 리다이렉트
categories: [Devops]
image: https://github.com/user-attachments/assets/8218274c-b2cc-46f1-8747-996bb80e95df
---

## 삐용삐용

옆 파트에서 배포하고 뭔가 에러가 난 것 같다. 
증상은 자꾸 mixed content 에러가 나고, 특정 api가 http로 자꾸 요청을 보내고 있었다.
금방 해결은 되었다. 팀장님이 url 매핑이 제대로 안 되서 난 에러라고 했다. 예시를 들자면,

```
@test.get("/hello")
```

서버는 이런식으로 경로 매핑이 되어 있는데,
프론트에서는 요청을

```
axios.get("/hello/")
```

이런 식으로 던져서 난 에러라는 것이다. 이게 문제의 원인이니 앞으로는 경로를 잘 매핑하라고 지시하고 갔는데, 
아무리 생각해도 근본적인 물음에 대한 답은 아닌 것 같았다.

'그러면 로컬에서는 왜 잘 되었을까?' '프로토콜은 왜 변경된걸까?'와 같은 나의 물음에 대한 정답은 아닌 것 같아서, 이리저리 생각해보며 찾아봤다.

## 직접 쏴보자

```sh
curl.exe -v -L -H "Authorization: Bearer 토큰" "https://..../store/category/"
* Host ....:443 was resolved.
* IPv6: (none)
* IPv4: ................
*   Trying ................:443...
* schannel: disabled automatic use of client certificate
* ALPN: curl offers http/1.1
* ALPN: server accepted http/1.1
* Connected to .... (................) port 443
* using HTTP/1.x
> GET /store/category/ HTTP/1.1
> Host: ....
> User-Agent: curl/8.10.1
> Accept: */*
> Authorization: Bearer 토큰
>
* schannel: remote party requests renegotiation
* schannel: renegotiating SSL/TLS connection
* schannel: SSL/TLS connection renegotiated
* Request completely sent off
< HTTP/1.1 307 Temporary Redirect
< Content-Length: 0
< Date: Sat, 26 Apr 2025 04:04:16 GMT
< Server: uvicorn
< Location: http://..../store/category
< Set-Cookie: ARRAffinity=e48c903aaf8196059893a3ed3b47c20426952958646a5aba4ab621ed7e181419;Path=/;HttpOnly;Secure;Domain=....
< Set-Cookie: ARRAffinitySameSite=e48c903aaf8196059893a3ed3b47c20426952958646a5aba4ab621ed7e181419;Path=/;HttpOnly;SameSite=None;Secure;Domain=....
< x-ms-middleware-request-id: 00000000-0000-0000-0000-000000000000
* Ignoring the response-body
* setting size while ignoring
<
* Connection #0 to host .... left intact
* Clear auth, redirects to port from 443 to 80
* Issue another request to this URL: 'http://..../store/category'
* Host ....:80 was resolved.
* IPv6: (none)
* IPv4: ................
*   Trying ................:80...
* Connected to .... (................) port 80
* using HTTP/1.x
> GET /store/category HTTP/1.1
> Host: ....
> User-Agent: curl/8.10.1
> Accept: */*
>
* Request completely sent off
< HTTP/1.1 301 Moved Permanently
< Content-Length: 0
< Date: Sat, 26 Apr 2025 04:04:16 GMT
< Location: https://..../store/category
* Ignoring the response-body
* setting size while ignoring
<
* Connection #1 to host .... left intact
* Clear auth, redirects to port from 80 to 443
* Issue another request to this URL: 'https://..../store/category'
* Re-using existing connection with host ....
> GET /store/category HTTP/1.1
> Host: ....
> User-Agent: curl/8.10.1
> Accept: */*
> Authorization: Bearer 토큰
>
* Request completely sent off
< HTTP/1.1 200 OK
< Content-Length: 160
< Content-Type: application/json
< Date: Sat, 26 Apr 2025 04:04:16 GMT
< Server: uvicorn
< Set-Cookie: ARRAffinity=e48c903aaf8196059893a3ed3b47c20426952958646a5aba4ab621ed7e181419;Path=/;HttpOnly;Secure;Domain=....
< Set-Cookie: ARRAffinitySameSite=e48c903aaf8196059893a3ed3b47c20426952958646a5aba4ab621ed7e181419;Path=/;HttpOnly;SameSite=None;Secure;Domain=....
< x-ms-middleware-request-id: 00000000-0000-0000-0000-000000000000
<
[{"id":"6791f33812cd7f5b4b2bc84a", .....},{"id":"6791f33812cd7f5b4b2bc84b",.....}]* Connection #0 to host .... left intact

```

![image](https://github.com/user-attachments/assets/5cf8071f-e568-4ddb-a9a6-54043f351e07)


![image](https://github.com/user-attachments/assets/3daa9855-24e6-4ecf-8bc0-c53c1d0c2842)


```sh
INFO: 127.0.0.1:5558 - "OPTIONS /store/category HTTP/1.1" 307 Temporary Redirect
```

- https://azure.github.io/AppService/2016/05/16/Disable-Session-affinity-cookie-(ARR-cookie)-for-Azure-web-apps.html
- https://learn.microsoft.com/en-us/azure/architecture/web-apps/app-service/architectures/basic-web-app
- https://learn.microsoft.com/en-us/archive/msdn-magazine/2017/february/azure-inside-the-azure-app-service-architecture


![image](https://github.com/user-attachments/assets/8218274c-b2cc-46f1-8747-996bb80e95df)

![image](https://github.com/user-attachments/assets/024c7a74-4738-4dbc-88f5-e96d75333800)

