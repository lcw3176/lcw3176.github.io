<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>STRIX</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css"
        integrity="sha512-MV7K8+y+gLIBoVD59lQIYicR65iaqukzvf/nwasF0nqhPay5w/9lJmVM2hMDcnK1OnMGCdVK+iQrJ7lzPJQd1w=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

    <meta property="og:title" content="STRIX">
    <meta property="og:description" content="String World">
    <meta property="og:url" content="https://lcw3176.github.io/">
    <script src='gifshot.min.js'></script>

    <style>
        html, body {
            margin: 0px;
            padding: 0px;
        }


        #imageSrc {
            width: 800px;
            height: auto;
        }

        
        #canvasOutput {
            background-color: black;
        }
    </style>
</head>

<body>
    <div class="container is-fluid">
        <nav class="navbar has-shadow">
            <div class="navbar-brand">
                <a class="navbar-item" href="index.html">
                    <p class="title">STRIX</p>
                </a>
            </div>

            <div class="navbar-start">
                <a class="navbar-item" href="image.html">
                    <p class="subtitle">이미지</p>
                </a>

                <a class="navbar-item" href="video.html">
                    <p class="subtitle">동영상</p>
                </a>
            </div>
        </nav>
        
        <div class="columns">
            <div class="column is-half is-offset-one-quarter mt-5 has-text-centered">
                <!-- <h1 class="title">String World</h1> -->
            </div>
        </div>

        <div class="columns">
            <div class="column is-half is-offset-one-quarter mt-5 has-text-centered">

                <div class="inputoutput">
                    <div class="file is-boxed is-centered">

                        <label class="file-label">
                            <figure class="image">
                                <video id="videoSrc" width="200px" height="200px"></video>
                            </figure>

                            <input type="file" id="fileInput" name="file" class="file-input" />
                            <span class="file-cta">
                                <span class="file-icon">
                                    <i class="fas fa-upload"></i>
                                </span>
                                <span class="file-label">
                                    동영상을 업로드하세요.
                                </span>
                            </span>
                        </label>
                    </div>
                </div>
            </div>
        </div>


        <div class="columns">
            <div class="column is-half is-offset-one-quarter mt-5 has-text-centered">
                <button class="button" onclick="start()" id="startButton">텍스트로 만들기</button>
            </div>
        </div>


        <div class="columns">
            <div class="column is-half is-offset-one-quarter mt-5 has-text-centered">
                <a class="subtitle has-text-success" id="downloadLink"></button>
            </div>
        </div>



        <div class="inputoutput">
            <canvas id="canvasOutput" style="display: none;"></canvas>
        </div>

    </div>


    <script type="text/javascript">
        window.onload = function () {
            var myFont = new FontFace('myFont', 'url(NanumGothicCoding-Bold.ttf)');

            myFont.load().then(function (font) {
                document.fonts.add(font);
            })
        }

        let videoElement = document.getElementById('videoSrc');
        let inputElement = document.getElementById('fileInput');

        const FPS = 10;
        let imageHeight = 0;
        let imageWidth = 0

        inputElement.addEventListener('change', (e) => {
            videoElement.src = URL.createObjectURL(e.target.files[0]);

        }, false);

        async function start() {
            if (videoElement.src == "") {
                alert("동영상을 먼저 업로드해주세요");
                return;
            }

            document.getElementById("startButton").className = "button is-loading";
            await makeVideo();
        }

        function makeVideo() {

            return new Promise(function (resolve, reject) {
                let video = document.getElementById('videoSrc');

                let src = new cv.Mat(video.height, video.width, cv.CV_8UC4);
                let dst = new cv.Mat(video.height, video.width, cv.CV_8UC1);
                let cap = new cv.VideoCapture(video);

                let arr = []
                let chars = ' .,-~:;=!*#$@';

                let imgArr = []



                function processVideo() {
                    cap.read(src)
                    cv.cvtColor(src, dst, cv.COLOR_RGBA2GRAY);

                    let w = dst.cols,
                        h = dst.rows;

                    let count = 0;

                    for (let i = 0; i < dst.data.length; i++) {
                        arr.push(chars[parseInt(dst.data[count] / 256 * chars.length)]);
                        count++;

                        if (count % w == 0) {
                            arr.push("\n");
                        }
                    }

                    if (video.currentTime < video.duration) {
                        let delay = 1 / FPS;
                        video.currentTime += delay

                        var canvas = document.getElementById("canvasOutput");
                        var ctx = canvas.getContext("2d");

                        ctx.clearRect(0, 0, canvas.width, canvas.height);

                        canvas.width = w * 2;
                        canvas.height = h * 2;
                        ctx.font = "2px myFont";
                        ctx.fillStyle = "white";
                        let textData = arr.join().split("\n");

                        for (let i = 0; i < textData.length; i++) {
                            ctx.fillText(textData[i], 0, i * 2);
                        }


                        canvas.toBlob(function (blob) {
                            imgArr.push(URL.createObjectURL(blob));

                        }, 'image/jpeg');

                        arr.length = 0;

                        setTimeout(processVideo, 10);
                    } else {
                        
                        src.delete();
                        dst.delete();

                        gifshot.createGIF({ 'images': imgArr , 'gifWidth': w * 2, 'gifHeight': h * 2}, function (obj) {
                            if (!obj.error) {
                                var link = document.getElementById('downloadLink');
                                link.download = 'strix.gif';
                                link.innerText = "다운로드";

                                link.href = obj.image;
                                document.getElementById("startButton").className = "button";
                                imgArr.length = 0;
                            }
                        });
                    }

                    
                };


                setTimeout(processVideo, 0);

            });

        }



    </script>
    <script async src="opencv.js" type="text/javascript"></script>
</body>

</html>